<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>V√≤ng Quay May M·∫Øn ITC</title>
  <link rel="stylesheet" href="css/typo/typo.css" />
  <link rel="stylesheet" href="css/hc-canvas-luckwheel.css" />
  <link rel="stylesheet" href="css/custom-styles.css" />

  <link href="./images/hengaplai.png" rel="icon" type="image/x-icon" />

  <style>
    /* Form Modal Styles */
    .prize-form-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      z-index: 10000;
      justify-content: center;
      align-items: center;
      animation: fadeIn 0.3s;
    }

    .prize-form-modal.active {
      display: flex;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
      }

      to {
        opacity: 1;
      }
    }

    .prize-form-content {
      background: white;
      padding: 40px;
      border-radius: 20px;
      max-width: 500px;
      width: 90%;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
      animation: slideUp 0.3s;
      max-height: 90vh;
      overflow-y: auto;
    }

    @keyframes slideUp {
      from {
        transform: translateY(50px);
        opacity: 0;
      }

      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    .prize-form-content h2 {
      color: #1E90FF;
      margin-bottom: 10px;
      font-size: 28px;
      text-align: center;
    }

    .prize-display-box {
      background: linear-gradient(135deg, #1E90FF 0%, #0066CC 100%);
      color: white;
      padding: 15px;
      border-radius: 10px;
      margin-bottom: 25px;
      text-align: center;
      font-size: 18px;
      font-weight: bold;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      color: #333;
      font-weight: 600;
      font-size: 15px;
    }

    .form-group input,
    .form-group textarea {
      width: 100%;
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 16px;
      transition: border-color 0.3s;
      font-family: inherit;
    }

    .form-group input:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: #1E90FF;
    }

    .form-group textarea {
      resize: vertical;
      min-height: 80px;
    }

    .form-actions {
      display: flex;
      gap: 10px;
      margin-top: 25px;
    }

    .form-btn {
      flex: 1;
      padding: 12px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .form-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }

    .btn-submit {
      background: linear-gradient(45deg, #1E90FF 0%, #0066CC 100%);
      color: white;
    }

    .btn-cancel {
      background: #f0f0f0;
      color: #666;
    }

    .form-loading {
      display: none;
      text-align: center;
      padding: 20px;
    }

    .form-loading.active {
      display: block;
    }

    .form-spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #1E90FF;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto;
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }

    @media (max-width: 480px) {
      .prize-form-content {
        padding: 25px;
      }

      .prize-form-content h2 {
        font-size: 22px;
      }

      .prize-display-box {
        font-size: 16px;
      }
    }
  </style>
</head>

<body class="bg">
  <div id="content" class="container">
    <div id="post">
      <div class="wrapper typo" id="wrapper">
        <section id="luckywheel" class="hc-luckywheel">
          <div class="hc-luckywheel-container">
            <canvas class="hc-luckywheel-canvas" width="500" height="500">V√≤ng Xoay May M·∫Øn</canvas>
          </div>
          <a class="hc-luckywheel-btn" href="javascript:;" id="spinButton">Xoay</a>
        </section>
      </div>

      <!-- Form Modal -->
      <div class="prize-form-modal" id="prizeFormModal">
        <div class="prize-form-content">
          <h2>üéâ Ch√∫c m·ª´ng b·∫°n!</h2>
          <div class="prize-display-box" id="prizeDisplayBox"></div>

          <form id="winnerForm">
            <div class="form-group">
              <label for="fullName">H·ªç v√† t√™n *</label>
              <input type="text" id="fullName" name="fullName" required placeholder="Nguy·ªÖn VƒÉn A">
            </div>

            <div class="form-group">
              <label for="phoneNumber">S·ªë ƒëi·ªán tho·∫°i *</label>
              <input type="tel" id="phoneNumber" name="phoneNumber" required placeholder="0912345678"
                pattern="[0-9]{10,11}">
            </div>

            <div class="form-group">
              <label for="userAddress">ƒê·ªãa ch·ªâ *</label>
              <textarea id="userAddress" name="userAddress" required
                placeholder="S·ªë nh√†, ƒë∆∞·ªùng, ph∆∞·ªùng/x√£, qu·∫≠n/huy·ªán, t·ªânh/th√†nh ph·ªë"></textarea>
            </div>

            <div class="form-actions">
              <button type="button" class="form-btn btn-cancel" id="cancelFormBtn">ƒê√≥ng</button>
              <button type="submit" class="form-btn btn-submit">G·ª≠i th√¥ng tin</button>
            </div>
          </form>

          <div class="form-loading" id="formLoading">
            <div class="form-spinner"></div>
            <p style="margin-top: 10px; color: #666;">ƒêang g·ª≠i...</p>
          </div>
        </div>
      </div>

      <script src="https://cdn.jsdelivr.net/npm/sweetalert2@9"></script>
      <script src="js/hc-canvas-luckwheel.js"></script>
      <script>
        // ‚ö†Ô∏è QUAN TR·ªåNG: Thay YOUR_SCRIPT_URL b·∫±ng Web App URL t·ª´ Google Apps Script
        const GOOGLE_SCRIPT_URL = 'YOUR_SCRIPT_URL';

        var isPercentage = true;
        var currentPrizeText = ''; // L∆∞u t√™n gi·∫£i th∆∞·ªüng

        // KI·ªÇM TRA XEM ƒê√É QUAY CH∆ØA
        const STORAGE_KEY = 'itc_wheel_played';

        function hasPlayed() {
          return localStorage.getItem(STORAGE_KEY) === 'true';
        }

        function markAsPlayed() {
          localStorage.setItem(STORAGE_KEY, 'true');
        }

        function showAlreadyPlayedMessage() {
          Swal.fire({
            title: 'ƒê√£ h·∫øt l∆∞·ª£t ch∆°i!',
            text: 'B·∫°n ƒë√£ quay v√≤ng quay r·ªìi. M·ªói ng∆∞·ªùi ch·ªâ ƒë∆∞·ª£c quay 1 l·∫ßn th√¥i',
            icon: 'warning',
            confirmButtonText: 'ƒê√£ hi·ªÉu',
            backdrop: false,
            allowOutsideClick: false
          });
        }

        function disableSpinButton() {
          const btn = document.querySelector('.hc-luckywheel-btn');
          btn.style.pointerEvents = 'none';
          btn.style.opacity = '0.5';
          btn.style.cursor = 'not-allowed';
        }

        // T·ªïng x√°c su·∫•t = 1.0 ch√≠nh x√°c
        var prizes = [
          {
            text: "Ch√∫c b·∫°n may m·∫Øn l·∫ßn sau",
            img: "images/hengaplai.png",
            percentpage: 0.01
          },
          {
            text: "Chu·ªôt Bluetooth",
            img: "images/chuot2.png",
            percentpage: 0.48
          },
          {
            text: "B√¨nh n∆∞·ªõc",
            img: "images/binh.png",
            percentpage: 0.02
          },
          {
            text: "USB 3.2 Kingston",
            img: "images/usb.png",
            percentpage: 0.01
          },
          {
            text: "Ch√∫c b·∫°n may m·∫Øn l·∫ßn sau",
            img: "images/hengaplai.png",
            percentpage: 0.48
          },
          {
            text: "G·∫•u b√¥ng",
            img: "images/gaubong.png",
            percentpage: 0.00
          },
          {
            text: "Qu√† b√≠ ·∫©n",
            img: "images/gift_Y.png",
            percentpage: 0.00
          },
          {
            text: "Balo ITC",
            img: "images/balo1.png",
            percentpage: 0.00
          },
        ];

        // Ki·ªÉm tra t·ªïng x√°c su·∫•t
        const totalProbability = prizes.reduce((sum, p) => sum + p.percentpage, 0);
        console.log("‚úÖ T·ªïng x√°c su·∫•t:", totalProbability.toFixed(2));

        const Toast = Swal.mixin({
          toast: true,
          position: 'center',
          showConfirmButton: false,
          timer: 8000,
          timerProgressBar: true,
          background: 'rgba(255, 255, 255, 0)',
          backdrop: false,
        });

        document.addEventListener(
          "DOMContentLoaded",
          function () {
            // LU√îN KH·ªûI T·∫†O V√íNG QUAY ƒê·ªÇ HI·ªÇN TH·ªä
            hcLuckywheel.init({
              id: "luckywheel",
              config: function (callback) {
                callback && callback(prizes);
              },
              mode: "both",
              getPrize: function (callback) {
                // KI·ªÇM TRA NGAY KHI CLICK N√öT QUAY
                if (hasPlayed()) {
                  showAlreadyPlayedMessage();
                  return; // Kh√¥ng g·ªçi callback -> kh√¥ng quay
                }

                var rand = randomIndex(prizes);
                var chances = rand;
                callback && callback([rand, chances]);
              },
              gotBack: function (data, index) {
                console.log("=== GOTBACK CALLED ===");
                console.log("Raw data:", data);
                console.log("Index:", index);

                // ƒê√ÅNH D·∫§U ƒê√É QUAY NGAY SAU KHI QUAY XONG
                markAsPlayed();

                // T·∫ÆT TO√ÄN B·ªò SWEETALERT T·ª™ TH∆Ø VI·ªÜN
                const originalSwal = window.Swal;
                window.Swal = {
                  fire: function () {
                    console.log("Swal.fire blocked from library");
                    return Promise.resolve();
                  }
                };

                // L·∫•y th√¥ng tin prize
                let prizeText = '';
                let prizeImg = '';

                if (typeof index === 'number' && prizes[index]) {
                  prizeText = prizes[index].text;
                  prizeImg = prizes[index].img;
                } else if (typeof data === 'string') {
                  prizeText = data;
                  let foundPrize = prizes.find(p => p.text === data);
                  prizeImg = foundPrize ? foundPrize.img : '';
                }

                console.log("Final prize text:", prizeText);
                console.log("Final prize img:", prizeImg);

                // L∆∞u t√™n gi·∫£i ƒë·ªÉ d√πng khi submit form
                currentPrizeText = prizeText;

                setTimeout(() => {
                  // KH√îI PH·ª§C L·∫†I SWAL
                  window.Swal = originalSwal;

                  if (!window.Swal || !window.Swal.fire) {
                    console.error("SweetAlert2 kh√¥ng kh·∫£ d·ª•ng");
                    alert(`Ch√∫c m·ª´ng! B·∫°n ƒë√£ tr√∫ng: ${prizeText}`);
                    return;
                  }

                  // X·ª≠ l√Ω c√°c tr∆∞·ªùng h·ª£p
                  if (data == null || prizeText == null) {
                    originalSwal.fire({
                      title: 'Ch∆∞∆°ng tr√¨nh k·∫øt th√∫c',
                      text: 'ƒê√£ h·∫øt ph·∫ßn th∆∞·ªüng',
                      icon: 'error',
                      confirmButtonText: 'ƒê√≥ng',
                      backdrop: false,
                      allowOutsideClick: false
                    });
                  } else if (prizeText === 'Ch√∫c b·∫°n may m·∫Øn l·∫ßn sau' || prizeText.includes('may m·∫Øn')) {
                    // KH√îNG TR√öNG - ch·ªâ hi·ªán th√¥ng b√°o
                    originalSwal.fire({
                      title: 'L·∫ßn n√†y b·∫°n ch∆∞a may m·∫Øn l·∫Øm',
                      text: 'Ch√∫c b·∫°n may m·∫Øn l·∫ßn sau. B·∫°n ƒë√£ h·∫øt l∆∞·ª£t ch∆°i!',
                      imageUrl: prizeImg || './images/hengaplai.png',
                      imageWidth: 100,
                      imageHeight: 100,
                      confirmButtonText: 'OK',
                      backdrop: false,
                      allowOutsideClick: false,
                      customClass: {
                        popup: 'simple-swal-popup',
                        confirmButton: 'simple-swal-button'
                      },
                      imageAlt: 'Logo ITC'
                    }).then(() => {
                      // V√¥ hi·ªáu h√≥a n√∫t quay
                      disableSpinButton();
                    }).catch(err => {
                      console.error("L·ªói hi·ªÉn th·ªã popup:", err);
                    });
                  } else {
                    // TR√öNG TH∆Ø·ªûNG - hi·ªán form thu th·∫≠p th√¥ng tin
                    document.getElementById('prizeDisplayBox').textContent = `B·∫°n ƒë√£ tr√∫ng: ${prizeText}`;
                    document.getElementById('prizeFormModal').classList.add('active');
                  }
                }, 100);
              }
            });

            // KI·ªÇM TRA SAU KHI KH·ªûI T·∫†O XONG
            if (hasPlayed()) {
              disableSpinButton();
              // Hi·ªán popup ngay khi v√†o trang
              setTimeout(() => {
                showAlreadyPlayedMessage();
              }, 500);
            }
          },
          false
        );

        function randomIndex(prizes) {
          if (!isPercentage) {
            return Math.floor(Math.random() * prizes.length);
          }

          let rand = Math.random();
          let cumulativeProbability = 0;

          console.log("Random value:", rand.toFixed(4));

          for (let i = 0; i < prizes.length; i++) {
            cumulativeProbability += prizes[i].percentpage;
            console.log(`  Index ${i}: cumulative = ${cumulativeProbability.toFixed(4)}`);

            if (rand < cumulativeProbability) {
              console.log(`Selected: Index ${i} - ${prizes[i].text}`);
              return i;
            }
          }

          console.warn("Fallback to last prize");
          return prizes.length - 1;
        }

        // X·ª¨ L√ù FORM
        document.getElementById('winnerForm').addEventListener('submit', async (e) => {
          e.preventDefault();

          const formData = {
            name: document.getElementById('fullName').value,
            phone: document.getElementById('phoneNumber').value,
            address: document.getElementById('userAddress').value,
            prize: currentPrizeText
          };

          // Hi·ªán loading
          document.getElementById('winnerForm').style.display = 'none';
          document.getElementById('formLoading').classList.add('active');

          try {
            const response = await fetch(GOOGLE_SCRIPT_URL, {
              method: 'POST',
              mode: 'no-cors',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify(formData)
            });

            // Do mode no-cors n√™n lu√¥n th√†nh c√¥ng
            setTimeout(() => {
              document.getElementById('formLoading').classList.remove('active');
              document.getElementById('prizeFormModal').classList.remove('active');

              Swal.fire({
                title: 'Th√†nh c√¥ng!',
                text: 'Th√¥ng tin c·ªßa b·∫°n ƒë√£ ƒë∆∞·ª£c ghi nh·∫≠n. ƒê·ªôi ng≈© admin s·∫Ω nhanh ch√≥ng li√™n l·∫°c v·ªõi b·∫°n ƒë·ªÉ x√°c nh·∫≠n th√¥ng tin nh·∫≠n th∆∞·ªüng!',
                icon: 'success',
                confirmButtonText: 'OK',
                backdrop: false,
                allowOutsideClick: false
              }).then(() => {
                document.getElementById('winnerForm').reset();
                document.getElementById('winnerForm').style.display = 'block';

                // V√¥ hi·ªáu h√≥a n√∫t quay
                disableSpinButton();
              });
            }, 1000);

          } catch (error) {
            document.getElementById('formLoading').classList.remove('active');
            document.getElementById('winnerForm').style.display = 'block';

            Swal.fire({
              title: 'L·ªói!',
              text: 'Kh√¥ng th·ªÉ g·ª≠i th√¥ng tin. Vui l√≤ng th·ª≠ l·∫°i!',
              icon: 'error',
              confirmButtonText: 'OK',
              backdrop: false,
              allowOutsideClick: false
            });
          }
        });

        // ƒê√≥ng modal
        document.getElementById('cancelFormBtn').addEventListener('click', () => {
          document.getElementById('prizeFormModal').classList.remove('active');
          document.getElementById('winnerForm').reset();
        });

      </script>
    </div>
  </div>
</body>

</html>